POST /api/login - Status: 500
Login failed. Please check the server logs for details.
Using test user with ID 6 for testing...

--- Testing Get Schedule Items ---
GET /api/schedule-management/items?userId=6&date=2025-03-30 - Status: 200
Found 7 schedule items for today: [
  {
    id: 144,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session (Updated)',
    description: '10-minute mindfulness practice - This item has been updated by the LLM',
    startTime: '08:00',
    endTime: '08:10',
    status: 'in_progress',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.593Z',
    updatedAt: '2025-03-30T18:58:38.593Z'
  },
  {
    id: 145,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.718Z',
    updatedAt: '2025-03-30T18:58:38.718Z'
  },
  {
    id: 143,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:33.319Z',
    updatedAt: '2025-03-30T18:58:33.319Z'
  },
  {
    id: 147,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:43.189Z',
    updatedAt: '2025-03-30T18:58:43.189Z'
  },
  {
    id: 151,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:50.342Z',
    updatedAt: '2025-03-30T19:00:50.342Z'
  },
  {
    id: 149,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:30.475Z',
    updatedAt: '2025-03-30T19:00:30.475Z'
  },
  {
    id: 153,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:02:30.808Z',
    updatedAt: '2025-03-30T19:02:30.808Z'
  }
]

--- Testing Basic Schedule Item Creation ---
POST /api/schedule-management/items - Status: 201
Created schedule item: {
  id: 154,
  userId: 6,
  scheduleId: null,
  date: '2025-03-30T00:00:00.000Z',
  taskId: null,
  subtaskId: null,
  title: 'Morning meditation session',
  description: '10-minute mindfulness practice',
  startTime: '08:00',
  endTime: '08:10',
  status: 'pending',
  notificationSent: false,
  createdAt: '2025-03-30T19:05:59.986Z',
  updatedAt: '2025-03-30T19:05:59.986Z'
}

--- Testing Schedule Item Creation with Task/Subtask Links ---
GET /api/tasks?userId=6 - Status: 401
Failed to create linked schedule item: TypeError: tasks is not iterable
    at testCreateLinkedScheduleItem (file:///home/runner/workspace/test-llm-schedule-management.js:160:24)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async runTests (file:///home/runner/workspace/test-llm-schedule-management.js:342:24)
Falling back to basic schedule item

--- Testing Basic Schedule Item Creation ---
POST /api/schedule-management/items - Status: 201
Created schedule item: {
  id: 155,
  userId: 6,
  scheduleId: null,
  date: '2025-03-30T00:00:00.000Z',
  taskId: null,
  subtaskId: null,
  title: 'Morning meditation session',
  description: '10-minute mindfulness practice',
  startTime: '08:00',
  endTime: '08:10',
  status: 'pending',
  notificationSent: false,
  createdAt: '2025-03-30T19:06:00.105Z',
  updatedAt: '2025-03-30T19:06:00.105Z'
}

--- Testing Schedule Item Update ---
PUT /api/schedule-management/items/154 - Status: 200
Updated schedule item: {
  id: 154,
  userId: 6,
  scheduleId: null,
  date: '2025-03-30T00:00:00.000Z',
  taskId: null,
  subtaskId: null,
  title: 'Morning meditation session (Updated)',
  description: '10-minute mindfulness practice - This item has been updated by the LLM',
  startTime: '08:00',
  endTime: '08:10',
  status: 'in_progress',
  notificationSent: false,
  createdAt: '2025-03-30T19:05:59.986Z',
  updatedAt: '2025-03-30T19:05:59.986Z'
}

--- Testing Marking Item as Complete ---
PUT /api/schedule-management/items/155 - Status: 200
Marked item as complete: {
  id: 155,
  userId: 6,
  scheduleId: null,
  date: '2025-03-30T00:00:00.000Z',
  taskId: null,
  subtaskId: null,
  title: 'Morning meditation session',
  description: '10-minute mindfulness practice',
  startTime: '08:00',
  endTime: '08:10',
  status: 'completed',
  notificationSent: false,
  createdAt: '2025-03-30T19:06:00.105Z',
  updatedAt: '2025-03-30T19:06:00.105Z'
}

--- Testing Message Scheduling ---
POST /api/schedule-management/messages - Status: 201
Scheduled follow-up message: {
  id: 164,
  userId: 6,
  type: 'follow_up',
  scheduledFor: '2025-03-30T19:21:00.257Z',
  sentAt: null,
  status: 'pending',
  metadata: { tone: 'encouraging', title: 'Progress check' },
  createdAt: '2025-03-30T19:06:00.291Z'
}

--- Testing Get Pending Messages ---
GET /api/schedule-management/messages?userId=6 - Status: 200
Found 7 pending messages: [
  {
    id: 159,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:38.876Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:38.914Z'
  },
  {
    id: 160,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:43.351Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:43.390Z'
  },
  {
    id: 161,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:15:30.627Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:00:30.664Z'
  },
  {
    id: 162,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:15:50.498Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:00:50.536Z'
  },
  {
    id: 163,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:17:30.968Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:02:31.013Z'
  },
  {
    id: 158,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:33.495Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:33.534Z'
  },
  {
    id: 164,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:21:00.257Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:06:00.291Z'
  }
]

--- Testing Get Schedule Items ---
GET /api/schedule-management/items?userId=6&date=2025-03-30 - Status: 200
Found 9 schedule items for today: [
  {
    id: 144,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session (Updated)',
    description: '10-minute mindfulness practice - This item has been updated by the LLM',
    startTime: '08:00',
    endTime: '08:10',
    status: 'in_progress',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.593Z',
    updatedAt: '2025-03-30T18:58:38.593Z'
  },
  {
    id: 145,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.718Z',
    updatedAt: '2025-03-30T18:58:38.718Z'
  },
  {
    id: 143,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:33.319Z',
    updatedAt: '2025-03-30T18:58:33.319Z'
  },
  {
    id: 154,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session (Updated)',
    description: '10-minute mindfulness practice - This item has been updated by the LLM',
    startTime: '08:00',
    endTime: '08:10',
    status: 'in_progress',
    notificationSent: false,
    createdAt: '2025-03-30T19:05:59.986Z',
    updatedAt: '2025-03-30T19:05:59.986Z'
  },
  {
    id: 147,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:43.189Z',
    updatedAt: '2025-03-30T18:58:43.189Z'
  },
  {
    id: 151,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:50.342Z',
    updatedAt: '2025-03-30T19:00:50.342Z'
  },
  {
    id: 149,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:30.475Z',
    updatedAt: '2025-03-30T19:00:30.475Z'
  },
  {
    id: 153,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:02:30.808Z',
    updatedAt: '2025-03-30T19:02:30.808Z'
  },
  {
    id: 155,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:06:00.105Z',
    updatedAt: '2025-03-30T19:06:00.105Z'
  }
]

--- Testing Schedule Item Soft Deletion ---
DELETE /api/schedule-management/items/154 - Status: 204
Soft-deleted schedule item: {
  success: true,
  status: 204,
  message: 'Operation completed successfully'
}

--- Testing Get Schedule Items ---
GET /api/schedule-management/items?userId=6&date=2025-03-30 - Status: 200
Found 8 schedule items for today: [
  {
    id: 144,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session (Updated)',
    description: '10-minute mindfulness practice - This item has been updated by the LLM',
    startTime: '08:00',
    endTime: '08:10',
    status: 'in_progress',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.593Z',
    updatedAt: '2025-03-30T18:58:38.593Z'
  },
  {
    id: 145,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:38.718Z',
    updatedAt: '2025-03-30T18:58:38.718Z'
  },
  {
    id: 143,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:33.319Z',
    updatedAt: '2025-03-30T18:58:33.319Z'
  },
  {
    id: 147,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T18:58:43.189Z',
    updatedAt: '2025-03-30T18:58:43.189Z'
  },
  {
    id: 151,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:50.342Z',
    updatedAt: '2025-03-30T19:00:50.342Z'
  },
  {
    id: 149,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:00:30.475Z',
    updatedAt: '2025-03-30T19:00:30.475Z'
  },
  {
    id: 153,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:02:30.808Z',
    updatedAt: '2025-03-30T19:02:30.808Z'
  },
  {
    id: 155,
    userId: 6,
    scheduleId: null,
    date: '2025-03-30T00:00:00.000Z',
    taskId: null,
    subtaskId: null,
    title: 'Morning meditation session',
    description: '10-minute mindfulness practice',
    startTime: '08:00',
    endTime: '08:10',
    status: 'completed',
    notificationSent: false,
    createdAt: '2025-03-30T19:06:00.105Z',
    updatedAt: '2025-03-30T19:06:00.105Z'
  }
]

--- Testing Message Schedule Soft Deletion ---
Attempting to delete message schedule with ID: 159
DELETE /api/schedule-management/messages/159 - Status: 200
Received HTML response, converting to JSON object
Soft-deleted message schedule result: {
  success: true,
  status: 200,
  message: 'Received HTML response with status 200'
}
GET /api/schedule-management/messages?userId=6 - Status: 200
Warning: Message 159 still appears in results after deletion: {
  id: 159,
  userId: 6,
  type: 'follow_up',
  scheduledFor: '2025-03-30T19:13:38.876Z',
  sentAt: null,
  status: 'pending',
  metadata: { tone: 'encouraging', title: 'Progress check' },
  createdAt: '2025-03-30T18:58:38.914Z'
}

--- Testing Get Pending Messages ---
GET /api/schedule-management/messages?userId=6 - Status: 200
Found 7 pending messages: [
  {
    id: 159,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:38.876Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:38.914Z'
  },
  {
    id: 160,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:43.351Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:43.390Z'
  },
  {
    id: 161,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:15:30.627Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:00:30.664Z'
  },
  {
    id: 162,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:15:50.498Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:00:50.536Z'
  },
  {
    id: 163,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:17:30.968Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:02:31.013Z'
  },
  {
    id: 158,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:13:33.495Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T18:58:33.534Z'
  },
  {
    id: 164,
    userId: 6,
    type: 'follow_up',
    scheduledFor: '2025-03-30T19:21:00.257Z',
    sentAt: null,
    status: 'pending',
    metadata: { tone: 'encouraging', title: 'Progress check' },
    createdAt: '2025-03-30T19:06:00.291Z'
  }
]

--- Test Summary ---
Initial schedule items: 7
After item soft-deletion: 8
Initial pending messages: 7
After message soft-deletion: 7
All tests completed successfully!
